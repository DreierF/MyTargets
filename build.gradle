buildscript {
    repositories {
        jcenter()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:2.1.2'
        classpath 'com.neenbedankt.gradle.plugins:android-apt:1.8'
        classpath 'me.tatarka:gradle-retrolambda:3.3.0-beta4'
        classpath 'com.mendhak.gradlecrowdin:crowdin-plugin:0.0.9'
        classpath 'me.tatarka.retrolambda.projectlombok:lombok.ast:0.2.3.a2'
        classpath 'com.github.triplet.gradle:play-publisher:1.1.4'
    }

    configurations.classpath.exclude group: 'com.android.tools.external.lombok'
}

plugins {
    id 'com.mendhak.gradlecrowdin' version '0.0.9'
}

ext {
    supportLibVersion = '23.4.0'
    playServiceVersion = '9.0.2'
    parcelerVersion = '1.1.5'
    appVersionName = '2.2.1'
    appVersionCode = 39
}

allprojects {
    repositories {
        jcenter()
        maven { url 'https://jitpack.io' }
        maven { url 'https://clojars.org/repo/' }
    }
}

crowdinUpload {
    apiKey = project.hasProperty('CROWDIN_API_KEY') ? CROWDIN_API_KEY : System.getenv('CROWDIN_API_KEY')
    projectId = 'mytargets'
    sourceFiles = [
            ['strings.xml', 'app/src/main/res/values/strings.xml'],
            ['strings-shared.xml', 'shared/src/main/res/values/strings.xml'],
            ['rounds.xml', 'shared/src/main/res/values/rounds.xml'],
            ['target_faces.xml', 'shared/src/main/res/values/target_faces.xml'],
            ['strings-wearable.xml', 'wearable/src/main/res/values/strings.xml']
    ]
}

crowdinDownload {
    apiKey = project.hasProperty('CROWDIN_API_KEY') ? CROWDIN_API_KEY : System.getenv('CROWDIN_API_KEY')
    projectId = 'mytargets'
    destination = "$projectDir"
    renameMapping  = [
            from:  '^(.*)/values-((?!(pt|zh))(.*)-r(.*)|((pt|zh).*))/(.*)$',
            to:  /\1\/values-\4\6\/\8/
    ]
}.dependsOn crowdinUpload

crowdinDownload.doLast {
    new File('app/src/main/play/af-ZA').deleteDir()
    new File('app/src/main/play/ar-SA').deleteDir()
    new File('app/src/main/play/da-DK').deleteDir()
    new File('app/src/main/play/el-GR').deleteDir()
    new File('app/src/main/play/fi-FI').deleteDir()
    new File('app/src/main/play/he-IL').deleteDir()
    new File('app/src/main/play/id-ID').deleteDir()
    new File('app/src/main/play/ko-KR').deleteDir()
    new File('app/src/main/play/ro-RO').deleteDir()
    new File('app/src/main/play/sr-SP').deleteDir()
    new File('app/src/main/play/uk-UA').deleteDir()
    new File('app/src/main/play/vi-VN').deleteDir()
}

subprojects.each { project ->
    project.tasks.whenTaskAdded { task ->
        if(task.name == 'preReleaseBuild') {
            task.dependsOn crowdinDownload
        }
    }
}